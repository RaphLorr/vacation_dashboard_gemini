<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIËØ∑ÂÅáÁúãÊùø</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.ico">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            height: 24px;
            width: auto;
            vertical-align: middle;
        }

        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0;
        }

        .upload-btn {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-toggle {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            min-width: 200px;
            max-height: 450px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-menu.show {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 13px;
            color: #333;
        }

        .filter-option:hover {
            background: #f0f3ff;
        }

        .filter-option input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .filter-btn {
            flex: 1;
            padding: 4px 8px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .employee-dept {
            font-size: 11px;
            color: #6c757d;
            font-weight: normal;
            margin-left: 8px;
        }

        .board-container {
            padding: 0;
            overflow-x: auto;
            overflow-y: auto;
            height: calc(100vh - 140px);
        }

        .leave-board {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .leave-board th,
        .leave-board td {
            border: 1px solid #e0e0e0;
            padding: 4px 6px;
            text-align: center;
            min-width: 50px;
        }

        .leave-board th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 6px;
        }

        .leave-board th.name-column {
            background: #e9ecef;
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 140px;
        }

        .leave-board td.name-column {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 9;
            text-align: left;
            padding: 4px 10px;
            white-space: nowrap;
        }

        .date-header {
            font-size: 10px;
            line-height: 1.3;
        }

        .date-day {
            display: block;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .date-type {
            display: block;
            font-size: 9px;
            color: #666;
        }

        .cell-leave-approved {
            background: #4ade80 !important;
            color: white;
            font-weight: 600;
        }

        .cell-leave-pending {
            background: #ffb347 !important;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
            color: white;
            font-weight: 600;
        }

        .cell-leave-approved small,
        .cell-leave-pending small {
            display: block;
            font-size: 9px;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 2px;
        }

        .cell-holiday {
            background: #d1d5db !important;
        }

        .cell-workday {
            background: white;
        }

        /* Highlighted row styles */
        .leave-board tbody tr.highlighted td {
            border-top: 3px solid #667eea !important;
            border-bottom: 3px solid #667eea !important;
        }

        .leave-board tbody tr.highlighted td.name-column {
            border-left: 6px solid #667eea !important;
            font-weight: 700;
        }

        .leave-board tbody tr.highlighted td:last-child {
            border-right: 3px solid #667eea !important;
        }

        .leave-board tbody tr {
            cursor: pointer;
        }

        .legend {
            padding: 6px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        .legend-color.leave-approved {
            background: #4ade80;
        }

        .legend-color.leave-pending {
            background: #ffb347;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
        }

        .legend-color.holiday {
            background: #d1d5db;
        }

        .legend-color.workday {
            background: white;
        }

        .stats {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            padding: 6px 20px;
            text-align: left;
            color: #666;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }


        /* Date range picker styles */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .date-range-picker .month-picker-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            position: relative;
        }

        .date-range-picker .month-picker-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .month-picker-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 12px;
            width: 220px;
            z-index: 1000;
            display: none;
        }

        .month-picker-menu.show {
            display: block;
        }

        .month-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .month-nav-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
            color: #555;
            transition: all 0.2s;
        }

        .month-nav-btn:hover {
            background: #f0f3ff;
            border-color: #667eea;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .month-grid-btn {
            padding: 8px 4px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            transition: all 0.2s;
            text-align: center;
        }

        .month-grid-btn:hover {
            background: #f0f3ff;
            border-color: #667eea;
        }

        .month-grid-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: 600;
        }

        .auto-sync-note {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: white;
        }

        @media (max-width: 768px) {
            /* Top bar: single compact row */
            .top-bar {
                padding: 6px 10px;
                gap: 6px;
            }

            /* Left controls: shrink filters inline */
            .top-bar > .left-controls {
                gap: 6px;
                flex: 1;
                min-width: 0;
            }

            /* User info: compact, no background */
            .top-bar > .user-info {
                padding: 0;
                background: none;
                backdrop-filter: none;
                gap: 6px;
                flex-shrink: 0;
            }

            /* Hide app title, sync status, auto-sync note on mobile */
            .header {
                display: none !important;
            }

            .sync-status,
            .auto-sync-note {
                display: none;
            }

            /* Compact filter buttons */
            .date-range-picker .month-picker-btn,
            .filter-toggle {
                padding: 4px 8px;
                font-size: 11px;
                gap: 4px;
            }

            /* Month picker & filter menu: bottom sheet on mobile */
            .month-picker-menu {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                margin-top: 0;
                border-radius: 12px 12px 0 0;
                width: 100%;
                padding: 16px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            }

            .month-grid-btn {
                padding: 12px 4px;
                font-size: 15px;
            }

            .filter-menu {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                margin-top: 0;
                border-radius: 12px 12px 0 0;
                max-height: 60vh;
                min-width: unset;
                padding: 12px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            }

            .filter-option {
                padding: 10px 8px;
                font-size: 15px;
            }

            /* User name: smaller */
            #userName {
                font-size: 12px;
            }

            /* Hide logout on mobile */
            .logout-btn {
                display: none;
            }

            /* Legend: compact */
            .legend {
                padding: 3px 10px;
                gap: 8px;
            }

            .legend-item {
                font-size: 10px;
            }

            .legend-color {
                width: 14px;
                height: 10px;
            }

            /* Table: tighter cells */
            .board-container {
                height: calc(100vh - 100px);
            }

            .leave-board th,
            .leave-board td {
                min-width: 36px;
                padding: 3px 3px;
                font-size: 10px;
            }

            .leave-board th.name-column {
                min-width: 90px;
            }

            .leave-board td.name-column {
                padding: 3px 6px;
                font-size: 11px;
            }

            .employee-dept {
                font-size: 9px;
            }

            /* Stats bar */
            .stats {
                padding: 3px 10px;
                font-size: 10px;
            }
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-content {
            background: white;
            padding: 40px 32px 32px 32px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            height: 60px;
            margin-bottom: 16px;
        }

        .login-header h2 {
            color: #333;
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .login-subtitle {
            color: #666;
            font-size: 15px;
            margin: 0 0 20px 0;
        }

        .wecom-login-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #07C160 0%, #06AD56 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.2);
        }

        .wecom-login-btn:hover {
            background: linear-gradient(135deg, #06AD56 0%, #059447 100%);
            box-shadow: 0 6px 16px rgba(7, 193, 96, 0.3);
            transform: translateY(-1px);
        }

        .wecom-login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 16px;
            padding: 12px;
            background: #ffebee;
            border-radius: 6px;
        }

        /* User info in header */
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: white;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .sync-status {
            font-size: 12px;
            opacity: 0.9;
            margin-right: 16px;
            color: rgba(255, 255, 255, 0.95);
        }

        #userName {
            font-weight: 500;
        }

        .logout-btn {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }


        /* QR Code Container - larger size for Web Login Component */
        .qr-code-container {
            width: 400px;
            height: 450px;
            margin: 0 auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            overflow: hidden;
        }

        /* Override iframe styles for login component */
        .qr-code-container iframe {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }
    </style>

    <!-- WeChat Work Web Login Component (@wecom/jssdk) -->
    <script src="https://wwcdn.weixin.qq.com/node/open/js/wecom-jssdk-2.3.3.js"></script>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal" style="display: none;">
        <div class="login-content">
            <div class="login-header">
                <img src="/logo.png" alt="Logo" class="login-logo">
                <h2>ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø</h2>
                <p class="login-subtitle">‰ºÅ‰∏öÂæÆ‰ø°ÁôªÂΩï</p>
            </div>

            <!-- QR Code Container -->
            <div id="wx_login_container" class="qr-code-container"></div>

            <div id="loginError" class="login-error" style="display: none;"></div>
        </div>
    </div>

    <div id="boardContainer" class="container">
        <div class="top-bar">
            <div class="left-controls">
                <div class="header">
                    <div>
                        <h1><img src="/logo.png" alt="Logo" class="header-logo"> ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø</h1>
                        <p id="dateRangeDisplay">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>

                <div class="date-range-picker">
                    <div class="month-picker-btn" onclick="toggleMonthPicker()">
                        <span>üìÖ <span id="monthDisplayText">ÈÄâÊã©Êúà‰ªΩ</span></span>
                    </div>
                    <div class="month-picker-menu" id="monthPickerMenu">
                        <div class="month-picker-header">
                            <button class="month-nav-btn" onclick="changePickerYear(-1)">‚óÄ</button>
                            <span id="pickerYearDisplay">2026</span>
                            <button class="month-nav-btn" onclick="changePickerYear(1)">‚ñ∂</button>
                        </div>
                        <div class="month-grid" id="monthGrid"></div>
                    </div>
                </div>

                <div class="filter-section" id="filterSection" style="display: none;">
                    <div class="filter-dropdown">
                        <button class="filter-toggle" onclick="toggleFilterMenu()">
                            <span>üìÇ ÈÉ®Èó®Á≠õÈÄâ</span>
                            <span id="filterCount"></span>
                        </button>
                        <div class="filter-menu" id="filterMenu">
                            <div id="departmentFilters"></div>
                            <div class="filter-actions">
                                <button class="filter-btn" onclick="selectAllDepartments()">ÂÖ®ÈÄâ</button>
                                <button class="filter-btn" onclick="clearAllDepartments()">Ê∏ÖÁ©∫</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User info and logout -->
            <div class="user-info">
                <span id="syncStatus" class="sync-status"></span>
                <span id="userName">Âä†ËΩΩ‰∏≠...</span>
                <button class="logout-btn" onclick="logout()">ÁôªÂá∫</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color leave-approved"></div>
                <span>ËØ∑ÂÅá(Â∑≤ÈÄöËøá)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color leave-pending"></div>
                <span>ËØ∑ÂÅá(ÂÆ°Êâπ‰∏≠)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color holiday"></div>
                <span>ÂÅáÊúü(‰ºë)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color workday"></div>
                <span>Â∑•‰ΩúÊó•(Áè≠)</span>
            </div>
        </div>

        <div class="board-container" id="tableContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                <p>ÂêéÂè∞Ê≠£Âú®Ëá™Âä®ÂêåÊ≠•ËØ∑ÂÅáËÆ∞ÂΩïÔºåËØ∑Á®çÂÄô...</p>
            </div>
        </div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        // ============================================
        // Authentication State
        // ============================================

        let currentUser = null;

        // Detect WeCom in-app browser (mobile or desktop)
        function isWeComBrowser() {
            return /wxwork/i.test(navigator.userAgent);
        }

        // Redirect to WeCom silent OAuth (for in-app browser only)
        async function redirectToWeComOAuth() {
            try {
                const configResponse = await fetch('/api/auth/config');
                const config = await configResponse.json();
                const state = generateRandomState();
                const redirectUri = encodeURIComponent(config.callbackUrl);
                const oauthUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${config.corpId}&redirect_uri=${redirectUri}&response_type=code&scope=snsapi_privateinfo&state=${state}&agentid=${config.agentId}#wechat_redirect`;
                window.location.href = oauthUrl;
            } catch (error) {
                console.error('[AUTH] WeCom silent OAuth redirect failed:', error);
                showLoginModal();
            }
        }

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/user/me', {
                    credentials: 'include',
                    cache: 'no-cache'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('userName').textContent = `‰Ω†Â•Ω, ${currentUser.name}`;
                    hideLoginModal();
                    return true;
                } else {
                    // In WeCom browser, try silent OAuth before showing QR modal
                    const urlParams = new URLSearchParams(window.location.search);
                    if (isWeComBrowser() && !urlParams.has('error')) {
                        console.log('[AUTH] WeCom browser detected, attempting silent OAuth...');
                        await redirectToWeComOAuth();
                        return false;
                    }
                    showLoginModal();
                    return false;
                }
            } catch (error) {
                console.error('[AUTH] Auth check failed:', error);
                const urlParams = new URLSearchParams(window.location.search);
                if (isWeComBrowser() && !urlParams.has('error')) {
                    console.log('[AUTH] WeCom browser detected, attempting silent OAuth...');
                    await redirectToWeComOAuth();
                    return false;
                }
                showLoginModal();
                return false;
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('boardContainer').style.display = 'none';

            // Check for error parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');

            if (error) {
                const errorDiv = document.getElementById('loginError');
                const errorMessages = {
                    'login_failed': 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï',
                    'no_code': 'ÊéàÊùÉÂ§±Ë¥•ÔºöÁº∫Â∞ëÊéàÊùÉÁ†Å',
                    'login_error': 'ÁôªÂΩïËøáÁ®ãÂá∫Èîô'
                };
                errorDiv.textContent = errorMessages[error] || 'ÁôªÂΩïÂ§±Ë¥•';
                errorDiv.style.display = 'block';
            }

            // Initialize QR code (only once)
            if (!window.wwLoginInitialized) {
                initializeQRCodeLogin();
                window.wwLoginInitialized = true;
            }
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('boardContainer').style.display = 'block';
        }

        // Generate random state for CSRF protection
        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) +
                   Math.random().toString(36).substring(2, 15);
        }

        // Initialize WeChat Work Web Login Component with auto-detection
        async function initializeQRCodeLogin() {
            try {
                // Fetch auth config from server
                const configResponse = await fetch('/api/auth/config');
                const config = await configResponse.json();

                // Generate random state for CSRF protection
                const state = generateRandomState();

                console.log('[AUTH] Initializing Web Login Component...');

                // Create Web Login Panel with WeChat Work client detection
                const wwLogin = ww.createWWLoginPanel({
                    el: '#wx_login_container',
                    params: {
                        login_type: 'CorpApp',
                        appid: config.corpId,
                        agentid: config.agentId,
                        redirect_uri: config.callbackUrl,
                        state: state,
                        redirect_type: 'callback'  // Use callback instead of redirect
                    },
                    onCheckWeComLogin({ isWeComLogin }) {
                        // Callback when checking if WeChat Work desktop client is logged in
                        console.log('[AUTH] WeChat Work desktop client detected:', isWeComLogin);
                        if (isWeComLogin) {
                            console.log('[AUTH] Desktop auto-login available');
                        } else {
                            console.log('[AUTH] Showing QR code for mobile scan');
                        }
                    },
                    onLoginSuccess({ code }) {
                        // Callback when login succeeds (desktop auto-login or QR scan)
                        console.log('[AUTH] Login successful, code:', code);
                        // Redirect to callback URL with code and state
                        window.location.href = `${config.callbackUrl}?code=${code}&state=${state}`;
                    },
                    onLoginFail(err) {
                        // Callback when login fails
                        console.error('[AUTH] Login failed:', err);
                        const errorDiv = document.getElementById('loginError');
                        errorDiv.textContent = 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                        errorDiv.style.display = 'block';
                    }
                });

                console.log('[AUTH] Web Login Component initialized');
            } catch (error) {
                console.error('[AUTH] Failed to initialize Web Login Component:', error);
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Âä†ËΩΩÁôªÂΩïÁªÑ‰ª∂Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
                errorDiv.style.display = 'block';
            }
        }

        async function logout() {
            if (!confirm('Á°ÆÂÆöË¶ÅÁôªÂá∫ÂêóÔºü')) return;

            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                currentUser = null;
                window.location.reload();
            } catch (error) {
                console.error('[AUTH] Logout failed:', error);
                alert('ÁôªÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Wrapper for fetch with authentication handling
        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                credentials: 'include'
            });

            if (response.status === 401) {
                console.warn('[AUTH] Unauthorized - redirecting to login');
                showLoginModal();
                throw new Error('Unauthorized');
            }

            return response;
        }

        // ============================================
        // Date Configuration & Leave Data
        // ============================================

        // ÂÖ®Â±ÄÊó•ÊúüÈÖçÁΩÆÔºàÂä®ÊÄÅÁîüÊàêÔºâ
        let dateConfig = [];
        let currentStartDate = null;
        let currentEndDate = null;

        // Custom month picker state
        let pickerYear = new Date().getFullYear();
        let selectedMonth = null; // e.g. "2026-02"

        // ÂàùÂßãÂåñÊúà‰ªΩÈÄâÊã©Âô®
        async function initializeDateRange() {
            try {
                const now = new Date();
                selectedMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                pickerYear = now.getFullYear();
                updateMonthDisplayText(selectedMonth);
                renderMonthGrid();

                await loadMonthData(selectedMonth);
            } catch (error) {
                console.error('Failed to initialize date range:', error);
                alert('ÂàùÂßãÂåñÊúà‰ªΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }

        function toggleMonthPicker() {
            const menu = document.getElementById('monthPickerMenu');
            menu.classList.toggle('show');
        }

        function changePickerYear(delta) {
            const newYear = pickerYear + delta;
            if (newYear < 2026) return;
            pickerYear = newYear;
            document.getElementById('pickerYearDisplay').textContent = pickerYear;
            renderMonthGrid();
        }

        function renderMonthGrid() {
            const grid = document.getElementById('monthGrid');
            document.getElementById('pickerYearDisplay').textContent = pickerYear;

            // Disable back arrow at min year
            const backBtn = document.querySelector('.month-nav-btn');
            if (backBtn) {
                backBtn.style.opacity = pickerYear <= 2026 ? '0.3' : '1';
                backBtn.style.pointerEvents = pickerYear <= 2026 ? 'none' : 'auto';
            }

            const months = ['1Êúà','2Êúà','3Êúà','4Êúà','5Êúà','6Êúà','7Êúà','8Êúà','9Êúà','10Êúà','11Êúà','12Êúà'];
            grid.innerHTML = months.map((label, i) => {
                const value = `${pickerYear}-${String(i + 1).padStart(2, '0')}`;
                const isActive = value === selectedMonth ? ' active' : '';
                return `<button class="month-grid-btn${isActive}" onclick="selectMonth('${value}')">${label}</button>`;
            }).join('');
        }

        async function selectMonth(yearMonth) {
            selectedMonth = yearMonth;
            const [y] = yearMonth.split('-').map(Number);
            pickerYear = y;
            updateMonthDisplayText(yearMonth);
            renderMonthGrid();
            document.getElementById('monthPickerMenu').classList.remove('show');
            await loadMonthData(yearMonth);
        }

        // Update visible month text (e.g. "2026-02" ‚Üí "2026Âπ¥2Êúà")
        function updateMonthDisplayText(yearMonth) {
            const [year, month] = yearMonth.split('-').map(Number);
            document.getElementById('monthDisplayText').textContent = `${year}Âπ¥${month}Êúà`;
        }

        // Âä†ËΩΩÊåáÂÆöÊúà‰ªΩÁöÑÊï∞ÊçÆ
        async function loadMonthData(yearMonth) {
            try {
                // Ëß£ÊûêÂπ¥Êúà (Ê†ºÂºè: "2026-02")
                const [year, month] = yearMonth.split('-').map(Number);

                // ËÆ°ÁÆóËØ•ÊúàÁöÑÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0); // ‰∏ã‰∏™ÊúàÁöÑÁ¨¨0Â§© = Ëøô‰∏™ÊúàÁöÑÊúÄÂêé‰∏ÄÂ§©

                const startDateStr = formatDate(startDate);
                const endDateStr = formatDate(endDate);

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                document.getElementById('dateRangeDisplay').textContent = 'Âä†ËΩΩ‰∏≠...';

                // Ëé∑ÂèñÊó•ÊúüÈÖçÁΩÆÔºàÂåÖÂê´ËäÇÂÅáÊó•‰ø°ÊÅØÔºâ
                const response = await fetchWithAuth(
                    `/api/holidays/dateconfig?startDate=${startDateStr}&endDate=${endDateStr}`
                );
                const result = await response.json();

                if (result.success) {
                    dateConfig = result.data.dateConfig;
                    currentStartDate = startDateStr;
                    currentEndDate = endDateStr;

                    // Êõ¥Êñ∞ÊòæÁ§∫
                    updateDateRangeDisplay();

                    // ÈáçÊñ∞Ê∏≤ÊüìÁúãÊùøÔºàÂ¶ÇÊûúÊúâÊï∞ÊçÆÔºâÔºå‰øùÁïôÂΩìÂâçÈÉ®Èó®Á≠õÈÄâ
                    if (globalLeaveData) {
                        renderFilteredBoard();
                    }

                    console.log(`‚úÖ Loaded ${dateConfig.length} days from ${startDateStr} to ${endDateStr}`);
                } else {
                    throw new Error(result.error || 'Failed to load date config');
                }
            } catch (error) {
                console.error('Failed to load month data:', error);
                alert('Âä†ËΩΩÊúà‰ªΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ê†ºÂºèÂåñÊó•Êúü‰∏∫ YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Êõ¥Êñ∞Êó•ÊúüËåÉÂõ¥ÊòæÁ§∫
        function updateDateRangeDisplay() {
            if (dateConfig.length === 0) {
                document.getElementById('dateRangeDisplay').textContent = 'Êó†Êï∞ÊçÆ';
                return;
            }

            const firstDate = dateConfig[0];
            const lastDate = dateConfig[dateConfig.length - 1];

            const startStr = `${firstDate.month}.${firstDate.day}`;
            const endStr = `${lastDate.month}.${lastDate.day}`;

            document.getElementById('dateRangeDisplay').textContent = `${startStr} - ${endStr} (${dateConfig.length}Â§©)`;
        }

        // ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ®
        let globalLeaveData = null;
        let globalEmployeeData = {};
        let selectedDepartments = new Set();

        function initializeDepartmentFilters(departments) {
            const filterContainer = document.getElementById('departmentFilters');
            const filterSection = document.getElementById('filterSection');

            if (departments.length === 0) {
                filterSection.style.display = 'none';
                return;
            }

            filterSection.style.display = 'flex';
            filterContainer.innerHTML = '';

            // ÈªòËÆ§ÂÖ®ÈÄâ
            selectedDepartments.clear();
            departments.forEach(dept => selectedDepartments.add(dept));

            departments.forEach(dept => {
                const option = document.createElement('label');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" value="${dept}" checked onchange="toggleDepartment('${dept}', this.checked)">
                    <span>${dept}</span>
                `;
                filterContainer.appendChild(option);
            });

            updateFilterCount();
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filterMenu');
            menu.classList.toggle('show');
        }

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(event) {
            const filterDropdown = document.querySelector('.filter-dropdown');
            const filterMenu = document.getElementById('filterMenu');
            if (filterDropdown && !filterDropdown.contains(event.target)) {
                filterMenu.classList.remove('show');
            }

            const datePicker = document.querySelector('.date-range-picker');
            const monthMenu = document.getElementById('monthPickerMenu');
            if (datePicker && !datePicker.contains(event.target)) {
                monthMenu.classList.remove('show');
            }
        });

        function toggleDepartment(dept, checked) {
            if (checked) {
                selectedDepartments.add(dept);
            } else {
                selectedDepartments.delete(dept);
            }

            updateFilterCount();
            applyFilters();
        }

        function selectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedDepartments.add(cb.value);
            });
            updateFilterCount();
            applyFilters();
        }

        function clearAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedDepartments.clear();
            updateFilterCount();
            applyFilters();
        }

        function updateFilterCount() {
            const filterCount = document.getElementById('filterCount');
            const total = document.querySelectorAll('#departmentFilters input[type="checkbox"]').length;
            const selected = selectedDepartments.size;

            if (selected === total) {
                filterCount.textContent = '(ÂÖ®ÈÉ®)';
            } else if (selected === 0) {
                filterCount.textContent = '(Êó†)';
            } else {
                filterCount.textContent = `(${selected}/${total})`;
            }
        }

        // Render board with current department filter applied
        function renderFilteredBoard() {
            if (!globalLeaveData) return;

            const filteredLeaveData = {};
            Object.keys(globalLeaveData).forEach(userid => {
                const empInfo = globalEmployeeData[userid];
                if (empInfo && selectedDepartments.has(empInfo.department)) {
                    filteredLeaveData[userid] = globalLeaveData[userid];
                }
            });

            renderBoard(filteredLeaveData, globalEmployeeData);
            updateStats(filteredLeaveData);
        }

        async function applyFilters() {
            // Reload data from server first to get latest updates (skip filter re-initialization)
            await loadDataFromServer(true);
            renderFilteredBoard();
        }

        function renderBoard(leaveRecords, employeeInfo) {
            // Now using userid as keys, sort by name for display
            const userids = Object.keys(leaveRecords).sort((a, b) => {
                const nameA = employeeInfo[a]?.name || a;
                const nameB = employeeInfo[b]?.name || b;
                return nameA.localeCompare(nameB);
            });

            let html = '<table class="leave-board"><thead><tr>';
            html += '<th class="name-column">ÂßìÂêç(ÈÉ®Èó®)</th>';

            // Êó•ÊúüË°®Â§¥ (strip year prefix, e.g. "2026-2.1" ‚Üí "2.1")
            dateConfig.forEach(({ date, type }) => {
                const shortDate = date.replace(/^\d{4}-/, '');
                html += `<th class="date-header">
                    <span class="date-day">${shortDate}</span>
                    <span class="date-type">(${type})</span>
                </th>`;
            });

            html += '</tr></thead><tbody>';

            // ÂëòÂ∑•Ë°å (iterate by userid, display name)
            userids.forEach(userid => {
                const empInfo = employeeInfo[userid] || { name: userid, department: 'Êú™Áü•' };
                const displayName = empInfo.name || userid;
                html += `<tr><td class="name-column">${displayName}<span class="employee-dept">(${empInfo.department})</span></td>`;

                dateConfig.forEach(({ date, type }) => {
                    const isHoliday = type === '‰ºë';
                    // Check for full day leave first
                    const fullDayLeave = leaveRecords[userid].get(date);

                    if (fullDayLeave) {
                        let cellClass = 'cell-workday';
                        let cellContent = '';
                        if (fullDayLeave === 'Â∑≤ÈÄöËøá') {
                            cellClass = 'cell-leave-approved';
                        } else if (fullDayLeave === 'ÂÆ°Êâπ‰∏≠') {
                            cellClass = 'cell-leave-pending';
                        } else if (isHoliday) {
                            cellClass = 'cell-holiday';
                        }
                        html += `<td class="${cellClass}">${cellContent}</td>`;
                    } else {
                        // Check both half-day slots independently
                        const morningLeave = leaveRecords[userid].get(`${date} (‰∏äÂçà)`);
                        const afternoonLeave = leaveRecords[userid].get(`${date} (‰∏ãÂçà)`);
                        // Only consider visible statuses (Â∑≤ÈÄöËøá or ÂÆ°Êâπ‰∏≠)
                        const morningVisible = (morningLeave === 'Â∑≤ÈÄöËøá' || morningLeave === 'ÂÆ°Êâπ‰∏≠') ? morningLeave : null;
                        const afternoonVisible = (afternoonLeave === 'Â∑≤ÈÄöËøá' || afternoonLeave === 'ÂÆ°Êâπ‰∏≠') ? afternoonLeave : null;

                        let cellClass = 'cell-workday';
                        let cellContent = '';

                        if (morningVisible && afternoonVisible) {
                            // Both halves active ‚Äî pick the "worse" status for cell color
                            cellClass = (morningVisible === 'ÂÆ°Êâπ‰∏≠' || afternoonVisible === 'ÂÆ°Êâπ‰∏≠')
                                ? 'cell-leave-pending' : 'cell-leave-approved';
                            cellContent = '<small>ÂÖ®Â§©</small>';
                        } else if (morningVisible) {
                            cellClass = morningVisible === 'Â∑≤ÈÄöËøá' ? 'cell-leave-approved' : 'cell-leave-pending';
                            cellContent = '<small>‰∏äÂçà</small>';
                        } else if (afternoonVisible) {
                            cellClass = afternoonVisible === 'Â∑≤ÈÄöËøá' ? 'cell-leave-approved' : 'cell-leave-pending';
                            cellContent = '<small>‰∏ãÂçà</small>';
                        } else if (isHoliday) {
                            cellClass = 'cell-holiday';
                        }

                        html += `<td class="${cellClass}">${cellContent}</td>`;
                    }
                });

                html += '</tr>';
            });

            html += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = html;

            // Add click event listener for row highlighting
            addRowHighlightListener();
        }

        function addRowHighlightListener() {
            const table = document.querySelector('.leave-board tbody');
            if (!table) return;

            // Event delegation: listen on tbody for clicks
            table.addEventListener('click', (e) => {
                // Find the clicked row (tr element)
                const clickedRow = e.target.closest('tr');
                if (!clickedRow) return;

                // Remove highlight from all rows
                const allRows = table.querySelectorAll('tr');
                allRows.forEach(row => row.classList.remove('highlighted'));

                // Add highlight to clicked row
                clickedRow.classList.add('highlighted');
            });
        }

        function updateStats(leaveRecords) {
            let employeesWithLeave = 0;
            let approvedCount = 0;
            let pendingCount = 0;

            // Only count records matching the selected month's dateConfig
            const monthDates = new Set(dateConfig.map(d => d.date));

            Object.keys(leaveRecords).forEach(userid => {
                const dateMap = leaveRecords[userid];
                let hasLeaveInMonth = false;

                monthDates.forEach(date => {
                    // Check full day, morning, afternoon ‚Äî same as renderBoard
                    const statuses = [
                        dateMap.get(date),
                        dateMap.get(`${date} (‰∏äÂçà)`),
                        dateMap.get(`${date} (‰∏ãÂçà)`)
                    ];

                    statuses.forEach(status => {
                        if (status === 'Â∑≤ÈÄöËøá') {
                            approvedCount++;
                            hasLeaveInMonth = true;
                        } else if (status === 'ÂÆ°Êâπ‰∏≠') {
                            pendingCount++;
                            hasLeaveInMonth = true;
                        }
                    });
                });

                if (hasLeaveInMonth) employeesWithLeave++;
            });

            document.getElementById('stats').innerHTML =
                `Êú¨Âë®ÊúüÂÖ± ${employeesWithLeave} ‰∫∫ËØ∑ÂÅá | Â∑≤ÈÄöËøáÔºö${approvedCount} Â§© | ÂÆ°Êâπ‰∏≠Ôºö${pendingCount} Â§©`;
        }

        // Load data from server on page load
        async function loadDataFromServer(skipFilterInit = false) {
            try {
                const response = await fetchWithAuth('/api/leave-records', {
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.leaveData && Object.keys(data.leaveData).length > 0) {
                        // Convert plain objects back to Maps for leave records
                        const leaveRecords = {};
                        Object.keys(data.leaveData).forEach(name => {
                            leaveRecords[name] = new Map(Object.entries(data.leaveData[name]));
                        });

                        globalLeaveData = leaveRecords;
                        globalEmployeeData = data.employeeInfo;

                        // Only initialize filters on first load, not when called from applyFilters
                        if (!skipFilterInit) {
                            const departments = new Set();
                            Object.values(data.employeeInfo).forEach(info => {
                                if (info.department) departments.add(info.department);
                            });

                            initializeDepartmentFilters(Array.from(departments).sort());
                            renderBoard(leaveRecords, data.employeeInfo);
                            updateStats(leaveRecords);
                        }

                        console.log('‚úÖ Data loaded from server');
                    }
                }
            } catch (error) {
                if (error.message === 'Unauthorized') {
                    return; // Already showing login modal
                }
                console.log('Server not available, starting with empty data');
            }
        }

        // Save data to server
        async function saveDataToServer(leaveRecords, employeeInfo) {
            try {
                // Convert Maps to plain objects for JSON
                const leaveData = {};
                Object.keys(leaveRecords).forEach(name => {
                    leaveData[name] = Object.fromEntries(leaveRecords[name]);
                });

                const payload = {
                    leaveData: leaveData,
                    employeeInfo: employeeInfo,
                    updatedAt: new Date().toISOString()
                };

                const response = await fetchWithAuth('/api/leave-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    console.log('‚úÖ Data saved to server');
                } else {
                    console.log('‚ö†Ô∏è Failed to save to server');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Server save failed:', error);
            }
        }

        // WeChat Work sync functionality
        // Helper function to format date as YYYY-MM-DD

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', async () => {
            // Resize WeCom built-in browser to a usable size
            if (isWeComBrowser()) {
                try {
                    window.moveTo(0, 0);
                    window.resizeTo(screen.availWidth, screen.availHeight);
                } catch (e) {
                    // Silently fail if not permitted
                }
            }

            console.log('[AUTH] Checking authentication...');
            const isAuthenticated = await checkAuth();

            if (isAuthenticated) {
                console.log('[AUTH] User authenticated, loading board...');
                // ÂÖàÂàùÂßãÂåñÊó•ÊúüËåÉÂõ¥
                await initializeDateRange();
                // ÁÑ∂ÂêéÂä†ËΩΩÊï∞ÊçÆ
                await loadDataFromServer();

                // Set sync status text
                const syncStatusEl = document.getElementById('syncStatus');
                if (syncStatusEl) {
                    syncStatusEl.textContent = 'ÊØè5ÂàÜÈíüÂêåÊ≠•‰ºÅÂæÆÊï∞ÊçÆ';
                }

                // Auto-refresh every 1 minute (60000ms)
                setInterval(async () => {
                    console.log('üîÑ Auto-refreshing data...');
                    await loadDataFromServer(true); // Pass true to skip filter re-initialization
                }, 60000);
            } else {
                console.log('[AUTH] User not authenticated, showing login...');
            }
        });
    </script>
</body>
</html>