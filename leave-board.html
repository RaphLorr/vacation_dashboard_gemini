<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø - ÂÜúÂéÜÊñ∞Âπ¥</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.ico">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            height: 24px;
            width: auto;
            vertical-align: middle;
        }

        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0;
        }

        .upload-btn {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-toggle {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-menu.show {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 13px;
            color: #333;
        }

        .filter-option:hover {
            background: #f0f3ff;
        }

        .filter-option input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .filter-btn {
            flex: 1;
            padding: 4px 8px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .employee-dept {
            font-size: 11px;
            color: #6c757d;
            font-weight: normal;
            margin-left: 8px;
        }

        .board-container {
            padding: 0;
            padding-bottom: 30px;
            overflow-x: auto;
            height: calc(100vh - 110px);
        }

        .leave-board {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .leave-board th,
        .leave-board td {
            border: 1px solid #e0e0e0;
            padding: 4px 6px;
            text-align: center;
            min-width: 50px;
        }

        .leave-board th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 6px;
        }

        .leave-board th.name-column {
            background: #e9ecef;
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 140px;
        }

        .leave-board td.name-column {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 9;
            text-align: left;
            padding: 4px 10px;
            white-space: nowrap;
        }

        .date-header {
            font-size: 10px;
            line-height: 1.3;
        }

        .date-day {
            display: block;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .date-type {
            display: block;
            font-size: 9px;
            color: #666;
        }

        .cell-leave-approved {
            background: #4ade80 !important;
            color: white;
            font-weight: 600;
        }

        .cell-leave-pending {
            background: #ffb347 !important;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
            color: white;
            font-weight: 600;
        }

        .cell-leave-approved small,
        .cell-leave-pending small {
            display: block;
            font-size: 9px;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 2px;
        }

        .cell-holiday {
            background: #d1d5db !important;
        }

        .cell-workday {
            background: white;
        }

        /* Highlighted row styles */
        .leave-board tbody tr.highlighted td {
            border-top: 3px solid #667eea !important;
            border-bottom: 3px solid #667eea !important;
        }

        .leave-board tbody tr.highlighted td.name-column {
            border-left: 6px solid #667eea !important;
            font-weight: 700;
        }

        .leave-board tbody tr.highlighted td:last-child {
            border-right: 3px solid #667eea !important;
        }

        .leave-board tbody tr {
            cursor: pointer;
        }

        .legend {
            padding: 6px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        .legend-color.leave-approved {
            background: #4ade80;
        }

        .legend-color.leave-pending {
            background: #ffb347;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
        }

        .legend-color.holiday {
            background: #d1d5db;
        }

        .legend-color.workday {
            background: white;
        }

        .stats {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            padding: 6px 20px;
            text-align: left;
            color: #666;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }


        /* Date range picker styles */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range-picker label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 13px;
        }

        .date-range-picker input[type="month"] {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-range-picker input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-range-picker input[type="month"]:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .date-range-picker input[type="month"]:focus {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .auto-sync-note {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }

            .legend {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="left-controls">
                <div class="header">
                    <div>
                        <h1><img src="/logo.png" alt="Logo" class="header-logo"> ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø</h1>
                        <p id="dateRangeDisplay">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                </div>

                <div class="date-range-picker">
                    <label>
                        <span>ÈÄâÊã©Êúà‰ªΩ:</span>
                        <input type="month" id="monthInput" onchange="onMonthChange()">
                    </label>
                </div>

                <div class="filter-section" id="filterSection" style="display: none;">
                    <div class="filter-dropdown">
                        <button class="filter-toggle" onclick="toggleFilterMenu()">
                            <span>üìÇ ÈÉ®Èó®Á≠õÈÄâ</span>
                            <span id="filterCount"></span>
                        </button>
                        <div class="filter-menu" id="filterMenu">
                            <div id="departmentFilters"></div>
                            <div class="filter-actions">
                                <button class="filter-btn" onclick="selectAllDepartments()">ÂÖ®ÈÄâ</button>
                                <button class="filter-btn" onclick="clearAllDepartments()">Ê∏ÖÁ©∫</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="auto-sync-note">
                <span>ü§ñ ÂêéÂè∞Ëá™Âä®ÂêåÊ≠•: ÊØè1ÂàÜÈíü</span>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color leave-approved"></div>
                <span>ËØ∑ÂÅá(Â∑≤ÈÄöËøá)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color leave-pending"></div>
                <span>ËØ∑ÂÅá(ÂÆ°Êâπ‰∏≠)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color holiday"></div>
                <span>ÂÅáÊúü(‰ºë)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color workday"></div>
                <span>Â∑•‰ΩúÊó•(Áè≠)</span>
            </div>
        </div>

        <div class="board-container" id="boardContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                <p>ÂêéÂè∞Ê≠£Âú®Ëá™Âä®ÂêåÊ≠•ËØ∑ÂÅáËÆ∞ÂΩïÔºåËØ∑Á®çÂÄô...</p>
            </div>
        </div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        // ÂÖ®Â±ÄÊó•ÊúüÈÖçÁΩÆÔºàÂä®ÊÄÅÁîüÊàêÔºâ
        let dateConfig = [];
        let currentStartDate = null;
        let currentEndDate = null;

        // ÂàùÂßãÂåñÊúà‰ªΩÈÄâÊã©Âô®
        async function initializeDateRange() {
            try {
                // ËÆæÁΩÆ‰∏∫ÂΩìÂâçÊúà‰ªΩ
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('monthInput').value = currentMonth;

                // Âä†ËΩΩÂΩìÂâçÊúà‰ªΩÁöÑÊï∞ÊçÆ
                await loadMonthData(currentMonth);
            } catch (error) {
                console.error('Failed to initialize date range:', error);
                alert('ÂàùÂßãÂåñÊúà‰ªΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }

        // Êúà‰ªΩÂèòÂåñÂ§ÑÁêÜ
        async function onMonthChange() {
            const month = document.getElementById('monthInput').value;
            if (month) {
                await loadMonthData(month);
            }
        }

        // Âä†ËΩΩÊåáÂÆöÊúà‰ªΩÁöÑÊï∞ÊçÆ
        async function loadMonthData(yearMonth) {
            try {
                // Ëß£ÊûêÂπ¥Êúà (Ê†ºÂºè: "2026-02")
                const [year, month] = yearMonth.split('-').map(Number);

                // ËÆ°ÁÆóËØ•ÊúàÁöÑÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0); // ‰∏ã‰∏™ÊúàÁöÑÁ¨¨0Â§© = Ëøô‰∏™ÊúàÁöÑÊúÄÂêé‰∏ÄÂ§©

                const startDateStr = formatDate(startDate);
                const endDateStr = formatDate(endDate);

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                document.getElementById('dateRangeDisplay').textContent = 'Âä†ËΩΩ‰∏≠...';

                // Ëé∑ÂèñÊó•ÊúüÈÖçÁΩÆÔºàÂåÖÂê´ËäÇÂÅáÊó•‰ø°ÊÅØÔºâ
                const response = await fetch(
                    `/api/holidays/dateconfig?startDate=${startDateStr}&endDate=${endDateStr}`
                );
                const result = await response.json();

                if (result.success) {
                    dateConfig = result.data.dateConfig;
                    currentStartDate = startDateStr;
                    currentEndDate = endDateStr;

                    // Êõ¥Êñ∞ÊòæÁ§∫
                    updateDateRangeDisplay();

                    // ÈáçÊñ∞Ê∏≤ÊüìÁúãÊùøÔºàÂ¶ÇÊûúÊúâÊï∞ÊçÆÔºâ
                    if (globalLeaveData) {
                        renderBoard(globalLeaveData, globalEmployeeData);
                        updateStats(globalLeaveData);
                    }

                    console.log(`‚úÖ Loaded ${dateConfig.length} days from ${startDateStr} to ${endDateStr}`);
                } else {
                    throw new Error(result.error || 'Failed to load date config');
                }
            } catch (error) {
                console.error('Failed to load month data:', error);
                alert('Âä†ËΩΩÊúà‰ªΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ê†ºÂºèÂåñÊó•Êúü‰∏∫ YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Êõ¥Êñ∞Êó•ÊúüËåÉÂõ¥ÊòæÁ§∫
        function updateDateRangeDisplay() {
            if (dateConfig.length === 0) {
                document.getElementById('dateRangeDisplay').textContent = 'Êó†Êï∞ÊçÆ';
                return;
            }

            const firstDate = dateConfig[0];
            const lastDate = dateConfig[dateConfig.length - 1];

            const startStr = `${firstDate.month}.${firstDate.day}`;
            const endStr = `${lastDate.month}.${lastDate.day}`;

            document.getElementById('dateRangeDisplay').textContent = `${startStr} - ${endStr} (${dateConfig.length}Â§©)`;
        }

        // ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ®
        let globalLeaveData = null;
        let globalEmployeeData = {};
        let selectedDepartments = new Set();

        function initializeDepartmentFilters(departments) {
            const filterContainer = document.getElementById('departmentFilters');
            const filterSection = document.getElementById('filterSection');

            if (departments.length === 0) {
                filterSection.style.display = 'none';
                return;
            }

            filterSection.style.display = 'flex';
            filterContainer.innerHTML = '';

            // ÈªòËÆ§ÂÖ®ÈÄâ
            selectedDepartments.clear();
            departments.forEach(dept => selectedDepartments.add(dept));

            departments.forEach(dept => {
                const option = document.createElement('label');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" value="${dept}" checked onchange="toggleDepartment('${dept}', this.checked)">
                    <span>${dept}</span>
                `;
                filterContainer.appendChild(option);
            });

            updateFilterCount();
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filterMenu');
            menu.classList.toggle('show');
        }

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(event) {
            const filterDropdown = document.querySelector('.filter-dropdown');
            const filterMenu = document.getElementById('filterMenu');
            if (filterDropdown && !filterDropdown.contains(event.target)) {
                filterMenu.classList.remove('show');
            }
        });

        function toggleDepartment(dept, checked) {
            if (checked) {
                selectedDepartments.add(dept);
            } else {
                selectedDepartments.delete(dept);
            }

            updateFilterCount();
            applyFilters();
        }

        function selectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedDepartments.add(cb.value);
            });
            updateFilterCount();
            applyFilters();
        }

        function clearAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedDepartments.clear();
            updateFilterCount();
            applyFilters();
        }

        function updateFilterCount() {
            const filterCount = document.getElementById('filterCount');
            const total = document.querySelectorAll('#departmentFilters input[type="checkbox"]').length;
            const selected = selectedDepartments.size;

            if (selected === total) {
                filterCount.textContent = '(ÂÖ®ÈÉ®)';
            } else if (selected === 0) {
                filterCount.textContent = '(Êó†)';
            } else {
                filterCount.textContent = `(${selected}/${total})`;
            }
        }

        async function applyFilters() {
            // Reload data from server first to get latest updates (skip filter re-initialization)
            await loadDataFromServer(true);

            if (!globalLeaveData) return;

            // Á≠õÈÄâÂëòÂ∑• (by userid now)
            const filteredLeaveData = {};
            Object.keys(globalLeaveData).forEach(userid => {
                const empInfo = globalEmployeeData[userid];
                if (empInfo && selectedDepartments.has(empInfo.department)) {
                    filteredLeaveData[userid] = globalLeaveData[userid];
                }
            });

            renderBoard(filteredLeaveData, globalEmployeeData);
            updateStats(filteredLeaveData);
        }

        function renderBoard(leaveRecords, employeeInfo) {
            // Now using userid as keys, sort by name for display
            const userids = Object.keys(leaveRecords).sort((a, b) => {
                const nameA = employeeInfo[a]?.name || a;
                const nameB = employeeInfo[b]?.name || b;
                return nameA.localeCompare(nameB);
            });

            let html = '<table class="leave-board"><thead><tr>';
            html += '<th class="name-column">ÂßìÂêç(ÈÉ®Èó®)</th>';

            // Êó•ÊúüË°®Â§¥
            dateConfig.forEach(({ date, type }) => {
                html += `<th class="date-header">
                    <span class="date-day">${date}</span>
                    <span class="date-type">(${type})</span>
                </th>`;
            });

            html += '</tr></thead><tbody>';

            // ÂëòÂ∑•Ë°å (iterate by userid, display name)
            userids.forEach(userid => {
                const empInfo = employeeInfo[userid] || { name: userid, department: 'Êú™Áü•' };
                const displayName = empInfo.name || userid;
                html += `<tr><td class="name-column">${displayName}<span class="employee-dept">(${empInfo.department})</span></td>`;

                dateConfig.forEach(({ date, type }) => {
                    // Check for full day leave first
                    let leaveStatus = leaveRecords[userid].get(date);
                    let timePeriod = null;

                    // If no full day leave, check for half-day leaves
                    if (!leaveStatus) {
                        const morningLeave = leaveRecords[userid].get(`${date} (‰∏äÂçà)`);
                        const afternoonLeave = leaveRecords[userid].get(`${date} (‰∏ãÂçà)`);

                        if (morningLeave) {
                            leaveStatus = morningLeave;
                            timePeriod = '‰∏äÂçà';
                        } else if (afternoonLeave) {
                            leaveStatus = afternoonLeave;
                            timePeriod = '‰∏ãÂçà';
                        }
                    }

                    const isHoliday = type === '‰ºë';
                    let cellClass = 'cell-workday';
                    let cellContent = '';

                    // Only display approved and pending statuses
                    if (leaveStatus === 'Â∑≤ÈÄöËøá') {
                        cellClass = 'cell-leave-approved';
                        cellContent = timePeriod ? `<small>${timePeriod}</small>` : '';
                    } else if (leaveStatus === 'ÂÆ°Êâπ‰∏≠') {
                        cellClass = 'cell-leave-pending';
                        cellContent = timePeriod ? `<small>${timePeriod}</small>` : '';
                    } else if (isHoliday) {
                        // For all other statuses (Â∑≤È©≥Âõû, Â∑≤Êí§ÈîÄ, etc.), treat as regular day
                        cellClass = 'cell-holiday';
                    }
                    // else: cellClass remains 'cell-workday' (hide rejected/cancelled)

                    html += `<td class="${cellClass}">${cellContent}</td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';

            document.getElementById('boardContainer').innerHTML = html;

            // Add click event listener for row highlighting
            addRowHighlightListener();
        }

        function addRowHighlightListener() {
            const table = document.querySelector('.leave-board tbody');
            if (!table) return;

            // Event delegation: listen on tbody for clicks
            table.addEventListener('click', (e) => {
                // Find the clicked row (tr element)
                const clickedRow = e.target.closest('tr');
                if (!clickedRow) return;

                // Remove highlight from all rows
                const allRows = table.querySelectorAll('tr');
                allRows.forEach(row => row.classList.remove('highlighted'));

                // Add highlight to clicked row
                clickedRow.classList.add('highlighted');
            });
        }

        function updateStats(leaveRecords) {
            const totalEmployees = Object.keys(leaveRecords).length;
            let totalLeaveDays = 0;
            let approvedCount = 0;
            let pendingCount = 0;

            Object.values(leaveRecords).forEach(dateMap => {
                totalLeaveDays += dateMap.size;
                dateMap.forEach(status => {
                    if (status === 'Â∑≤ÈÄöËøá') {
                        approvedCount++;
                    } else {
                        pendingCount++;
                    }
                });
            });

            document.getElementById('stats').innerHTML =
                `ÂÖ± ${totalEmployees} ‰∫∫ | ËØ∑ÂÅáÊÄªÂ§©Êï∞Ôºö${totalLeaveDays} Â§© | Â∑≤ÈÄöËøáÔºö${approvedCount} Â§© | ÂÆ°Êâπ‰∏≠Ôºö${pendingCount} Â§©`;
        }

        // Load data from server on page load
        async function loadDataFromServer(skipFilterInit = false) {
            try {
                const response = await fetch('/api/leave-records', {
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.leaveData && Object.keys(data.leaveData).length > 0) {
                        // Convert plain objects back to Maps for leave records
                        const leaveRecords = {};
                        Object.keys(data.leaveData).forEach(name => {
                            leaveRecords[name] = new Map(Object.entries(data.leaveData[name]));
                        });

                        globalLeaveData = leaveRecords;
                        globalEmployeeData = data.employeeInfo;

                        // Only initialize filters on first load, not when called from applyFilters
                        if (!skipFilterInit) {
                            const departments = new Set();
                            Object.values(data.employeeInfo).forEach(info => {
                                if (info.department) departments.add(info.department);
                            });

                            initializeDepartmentFilters(Array.from(departments).sort());
                            renderBoard(leaveRecords, data.employeeInfo);
                            updateStats(leaveRecords);
                        }

                        console.log('‚úÖ Data loaded from server');
                    }
                }
            } catch (error) {
                console.log('Server not available, starting with empty data');
            }
        }

        // Save data to server
        async function saveDataToServer(leaveRecords, employeeInfo) {
            try {
                // Convert Maps to plain objects for JSON
                const leaveData = {};
                Object.keys(leaveRecords).forEach(name => {
                    leaveData[name] = Object.fromEntries(leaveRecords[name]);
                });

                const payload = {
                    leaveData: leaveData,
                    employeeInfo: employeeInfo,
                    updatedAt: new Date().toISOString()
                };

                const response = await fetch('/api/leave-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    console.log('‚úÖ Data saved to server');
                } else {
                    console.log('‚ö†Ô∏è Failed to save to server');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Server save failed:', error);
            }
        }

        // WeChat Work sync functionality
        // Helper function to format date as YYYY-MM-DD

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', async () => {
            // ÂÖàÂàùÂßãÂåñÊó•ÊúüËåÉÂõ¥
            await initializeDateRange();
            // ÁÑ∂ÂêéÂä†ËΩΩÊï∞ÊçÆ
            await loadDataFromServer();
        });
    </script>
</body>
</html>