<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø - ÂÜúÂéÜÊñ∞Âπ¥</title>
    <script src="https://registry.npmmirror.com/xlsx/0.18.5/files/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0;
        }

        .upload-btn {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #fileInput {
            display: none;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-toggle {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-menu.show {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 13px;
            color: #333;
        }

        .filter-option:hover {
            background: #f0f3ff;
        }

        .filter-option input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .filter-btn {
            flex: 1;
            padding: 4px 8px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .employee-dept {
            font-size: 11px;
            color: #6c757d;
            font-weight: normal;
            margin-left: 8px;
        }

        .board-container {
            padding: 0;
            overflow-x: auto;
            height: calc(100vh - 50px);
        }

        .leave-board {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .leave-board th,
        .leave-board td {
            border: 1px solid #e0e0e0;
            padding: 4px 6px;
            text-align: center;
            min-width: 50px;
        }

        .leave-board th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 6px;
        }

        .leave-board th.name-column {
            background: #e9ecef;
            position: sticky;
            left: 0;
            z-index: 11;
            min-width: 140px;
        }

        .leave-board td.name-column {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 9;
            text-align: left;
            padding: 4px 10px;
            white-space: nowrap;
        }

        .date-header {
            font-size: 10px;
            line-height: 1.3;
        }

        .date-day {
            display: block;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .date-type {
            display: block;
            font-size: 9px;
            color: #666;
        }

        .cell-leave-approved {
            background: #ff8c00 !important;
            color: white;
            font-weight: 600;
        }

        .cell-leave-pending {
            background: #ffb347 !important;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
            color: white;
            font-weight: 600;
        }

        .cell-holiday {
            background: #90EE90 !important;
        }

        .cell-workday {
            background: white;
        }

        .legend {
            padding: 6px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        .legend-color.leave-approved {
            background: #ff8c00;
        }

        .legend-color.leave-pending {
            background: #ffb347;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.3) 5px,
                rgba(255, 255, 255, 0.3) 10px
            );
        }

        .legend-color.holiday {
            background: #90EE90;
        }

        .legend-color.workday {
            background: white;
        }

        .stats {
            padding: 6px 20px;
            text-align: left;
            color: #666;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }

            .legend {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="header">
                <div>
                    <h1>üéä ËØ∑ÂÅáËÆ∞ÂΩïÁúãÊùø</h1>
                    <p>2.11 - 2.28</p>
                </div>
            </div>

            <div class="filter-section" id="filterSection" style="display: none;">
                <div class="filter-dropdown">
                    <button class="filter-toggle" onclick="toggleFilterMenu()">
                        <span>üìÇ ÈÉ®Èó®Á≠õÈÄâ</span>
                        <span id="filterCount"></span>
                    </button>
                    <div class="filter-menu" id="filterMenu">
                        <div id="departmentFilters"></div>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllDepartments()">ÂÖ®ÈÄâ</button>
                            <button class="filter-btn" onclick="clearAllDepartments()">Ê∏ÖÁ©∫</button>
                        </div>
                    </div>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÅ ‰∏ä‰º†Excel
            </button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color leave-approved"></div>
                <span>ËØ∑ÂÅá(Â∑≤ÈÄöËøá)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color leave-pending"></div>
                <span>ËØ∑ÂÅá(ÂÆ°Êâπ‰∏≠)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color holiday"></div>
                <span>ÂÅáÊúü(‰ºë)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color workday"></div>
                <span>Â∑•‰ΩúÊó•(Áè≠)</span>
            </div>
        </div>

        <div class="board-container" id="boardContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                <p>ËØ∑‰∏ä‰º†ExcelÊñá‰ª∂Êü•ÁúãËØ∑ÂÅáËÆ∞ÂΩï</p>
            </div>
        </div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        // Êó•ÊúüÈÖçÁΩÆÔºö2.11-2.28
        const dateConfig = [
            { date: '2.11', type: 'Áè≠' },
            { date: '2.12', type: 'Áè≠' },
            { date: '2.13', type: 'Áè≠' },
            { date: '2.14', type: 'Áè≠' },
            { date: '2.15', type: '‰ºë' },
            { date: '2.16', type: '‰ºë' },
            { date: '2.17', type: '‰ºë' },
            { date: '2.18', type: '‰ºë' },
            { date: '2.19', type: '‰ºë' },
            { date: '2.20', type: '‰ºë' },
            { date: '2.21', type: '‰ºë' },
            { date: '2.22', type: '‰ºë' },
            { date: '2.23', type: '‰ºë' },
            { date: '2.24', type: 'Áè≠' },
            { date: '2.25', type: 'Áè≠' },
            { date: '2.26', type: 'Áè≠' },
            { date: '2.27', type: 'Áè≠' },
            { date: '2.28', type: 'Áè≠' }
        ];

        // Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    processLeaveData(jsonData);
                } catch (error) {
                    alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øù‰∏ä‰º†ÁöÑÊòØÊ≠£Á°ÆÁöÑExcelÊñá‰ª∂');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ®
        let globalLeaveData = null;
        let globalEmployeeData = {};
        let selectedDepartments = new Set();

        function processLeaveData(data) {
            // Ëß£ÊûêËØ∑ÂÅáËÆ∞ÂΩï
            const leaveRecords = {};
            const employeeInfo = {};
            const departments = new Set();

            data.forEach(row => {
                const name = row['Áî≥ËØ∑‰∫∫'];
                const dept = row['Áî≥ËØ∑‰∫∫ÈÉ®Èó®'];
                const startTime = row['ÂºÄÂßãÊó∂Èó¥'];
                const endTime = row['ÁªìÊùüÊó∂Èó¥'];
                const status = row['ÂΩìÂâçÂÆ°ÊâπÁä∂ÊÄÅ'];

                // Âè™Â§ÑÁêÜÂ∑≤ÈÄöËøáÂíåÂÆ°Êâπ‰∏≠ÁöÑËØ∑ÂÅá
                if (!name || !startTime || !endTime) return;

                // ËÆ∞ÂΩïÂëòÂ∑•‰ø°ÊÅØ
                if (!employeeInfo[name]) {
                    employeeInfo[name] = {
                        department: dept || 'Êú™Áü•'
                    };
                    departments.add(dept || 'Êú™Áü•');
                }

                if (!leaveRecords[name]) {
                    leaveRecords[name] = new Map();
                }

                // Ëß£ÊûêÊó•ÊúüËåÉÂõ¥
                const leaveDates = parseDateRange(startTime, endTime);
                leaveDates.forEach(date => {
                    // Â¶ÇÊûúÂêå‰∏ÄÂ§©ÊúâÂ§ö‰∏™ËØ∑ÂÅáËÆ∞ÂΩïÔºå‰ºòÂÖàÊòæÁ§∫Â∑≤ÈÄöËøáÁöÑ
                    const currentStatus = leaveRecords[name].get(date);
                    if (!currentStatus || (status === 'Â∑≤ÈÄöËøá' && currentStatus !== 'Â∑≤ÈÄöËøá')) {
                        leaveRecords[name].set(date, status);
                    }
                });
            });

            // ‰øùÂ≠òÂÖ®Â±ÄÊï∞ÊçÆ
            globalLeaveData = leaveRecords;
            globalEmployeeData = employeeInfo;

            // ÂàùÂßãÂåñÈÉ®Èó®Á≠õÈÄâÂô®
            initializeDepartmentFilters(Array.from(departments).sort());

            // Ê∏≤ÊüìÁúãÊùø
            renderBoard(leaveRecords, employeeInfo);
            updateStats(leaveRecords);

            // ‰øùÂ≠òÂà∞ÊúçÂä°Âô®
            saveDataToServer(leaveRecords, employeeInfo);
        }

        function initializeDepartmentFilters(departments) {
            const filterContainer = document.getElementById('departmentFilters');
            const filterSection = document.getElementById('filterSection');

            if (departments.length === 0) {
                filterSection.style.display = 'none';
                return;
            }

            filterSection.style.display = 'flex';
            filterContainer.innerHTML = '';

            // ÈªòËÆ§ÂÖ®ÈÄâ
            selectedDepartments.clear();
            departments.forEach(dept => selectedDepartments.add(dept));

            departments.forEach(dept => {
                const option = document.createElement('label');
                option.className = 'filter-option';
                option.innerHTML = `
                    <input type="checkbox" value="${dept}" checked onchange="toggleDepartment('${dept}', this.checked)">
                    <span>${dept}</span>
                `;
                filterContainer.appendChild(option);
            });

            updateFilterCount();
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filterMenu');
            menu.classList.toggle('show');
        }

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(event) {
            const filterDropdown = document.querySelector('.filter-dropdown');
            const filterMenu = document.getElementById('filterMenu');
            if (filterDropdown && !filterDropdown.contains(event.target)) {
                filterMenu.classList.remove('show');
            }
        });

        function toggleDepartment(dept, checked) {
            if (checked) {
                selectedDepartments.add(dept);
            } else {
                selectedDepartments.delete(dept);
            }

            updateFilterCount();
            applyFilters();
        }

        function selectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                selectedDepartments.add(cb.value);
            });
            updateFilterCount();
            applyFilters();
        }

        function clearAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentFilters input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            selectedDepartments.clear();
            updateFilterCount();
            applyFilters();
        }

        function updateFilterCount() {
            const filterCount = document.getElementById('filterCount');
            const total = document.querySelectorAll('#departmentFilters input[type="checkbox"]').length;
            const selected = selectedDepartments.size;

            if (selected === total) {
                filterCount.textContent = '(ÂÖ®ÈÉ®)';
            } else if (selected === 0) {
                filterCount.textContent = '(Êó†)';
            } else {
                filterCount.textContent = `(${selected}/${total})`;
            }
        }

        function applyFilters() {
            if (!globalLeaveData) return;

            // Á≠õÈÄâÂëòÂ∑•
            const filteredLeaveData = {};
            Object.keys(globalLeaveData).forEach(name => {
                const empInfo = globalEmployeeData[name];
                if (empInfo && selectedDepartments.has(empInfo.department)) {
                    filteredLeaveData[name] = globalLeaveData[name];
                }
            });

            renderBoard(filteredLeaveData, globalEmployeeData);
            updateStats(filteredLeaveData);
        }

        function parseDateRange(startTime, endTime) {
            const dates = [];

            // Ëß£ÊûêÂºÄÂßãÂíåÁªìÊùüÊó•Êúü (Ê†ºÂºè: "2026/2/14 ‰∏äÂçà" Êàñ "2026/2/14 ‰∏ãÂçà")
            const startMatch = startTime.match(/2026\/2\/(\d+)/);
            const endMatch = endTime.match(/2026\/2\/(\d+)/);

            if (!startMatch || !endMatch) return dates;

            const startDay = parseInt(startMatch[1]);
            const endDay = parseInt(endMatch[1]);

            // Âè™ËÄÉËôë2Êúà11-28Êó•ËåÉÂõ¥
            for (let day = Math.max(11, startDay); day <= Math.min(28, endDay); day++) {
                dates.push(`2.${day}`);
            }

            return dates;
        }

        function renderBoard(leaveRecords, employeeInfo) {
            const employees = Object.keys(leaveRecords).sort();

            let html = '<table class="leave-board"><thead><tr>';
            html += '<th class="name-column">ÂßìÂêç(ÈÉ®Èó®)</th>';

            // Êó•ÊúüË°®Â§¥
            dateConfig.forEach(({ date, type }) => {
                html += `<th class="date-header">
                    <span class="date-day">${date}</span>
                    <span class="date-type">(${type})</span>
                </th>`;
            });

            html += '</tr></thead><tbody>';

            // ÂëòÂ∑•Ë°å
            employees.forEach(name => {
                const empInfo = employeeInfo[name] || { department: 'Êú™Áü•' };
                html += `<tr><td class="name-column">${name}<span class="employee-dept">(${empInfo.department})</span></td>`;

                dateConfig.forEach(({ date, type }) => {
                    const leaveStatus = leaveRecords[name].get(date);
                    const isHoliday = type === '‰ºë';

                    let cellClass = 'cell-workday';
                    if (leaveStatus) {
                        if (leaveStatus === 'Â∑≤ÈÄöËøá') {
                            cellClass = 'cell-leave-approved';
                        } else {
                            cellClass = 'cell-leave-pending';
                        }
                    } else if (isHoliday) {
                        cellClass = 'cell-holiday';
                    }

                    html += `<td class="${cellClass}"></td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';

            document.getElementById('boardContainer').innerHTML = html;
        }

        function updateStats(leaveRecords) {
            const totalEmployees = Object.keys(leaveRecords).length;
            let totalLeaveDays = 0;
            let approvedCount = 0;
            let pendingCount = 0;

            Object.values(leaveRecords).forEach(dateMap => {
                totalLeaveDays += dateMap.size;
                dateMap.forEach(status => {
                    if (status === 'Â∑≤ÈÄöËøá') {
                        approvedCount++;
                    } else {
                        pendingCount++;
                    }
                });
            });

            document.getElementById('stats').innerHTML =
                `ÂÖ± ${totalEmployees} ‰∫∫ | ËØ∑ÂÅáÊÄªÂ§©Êï∞Ôºö${totalLeaveDays} Â§© | Â∑≤ÈÄöËøáÔºö${approvedCount} Â§© | ÂÆ°Êâπ‰∏≠Ôºö${pendingCount} Â§©`;
        }

        // Load data from server on page load
        async function loadDataFromServer() {
            try {
                const response = await fetch('/api/leave-records');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.leaveData && Object.keys(data.leaveData).length > 0) {
                        // Convert plain objects back to Maps for leave records
                        const leaveRecords = {};
                        Object.keys(data.leaveData).forEach(name => {
                            leaveRecords[name] = new Map(Object.entries(data.leaveData[name]));
                        });

                        globalLeaveData = leaveRecords;
                        globalEmployeeData = data.employeeInfo;

                        const departments = new Set();
                        Object.values(data.employeeInfo).forEach(info => {
                            if (info.department) departments.add(info.department);
                        });

                        initializeDepartmentFilters(Array.from(departments).sort());
                        renderBoard(leaveRecords, data.employeeInfo);
                        updateStats(leaveRecords);

                        console.log('‚úÖ Data loaded from server');
                    }
                }
            } catch (error) {
                console.log('Server not available, starting with empty data');
            }
        }

        // Save data to server
        async function saveDataToServer(leaveRecords, employeeInfo) {
            try {
                // Convert Maps to plain objects for JSON
                const leaveData = {};
                Object.keys(leaveRecords).forEach(name => {
                    leaveData[name] = Object.fromEntries(leaveRecords[name]);
                });

                const payload = {
                    leaveData: leaveData,
                    employeeInfo: employeeInfo,
                    updatedAt: new Date().toISOString()
                };

                const response = await fetch('/api/leave-records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    console.log('‚úÖ Data saved to server');
                } else {
                    console.log('‚ö†Ô∏è Failed to save to server');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Server save failed:', error);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂‰ªéÊúçÂä°Âô®Âä†ËΩΩÊï∞ÊçÆ
        window.addEventListener('DOMContentLoaded', loadDataFromServer);
    </script>
</body>
</html>